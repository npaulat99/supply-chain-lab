name: Supply Chain CI

on:
  push:
    branches:
      - main

permissions:
  id-token: write      # OIDC fÃ¼r Cosign keyless signing
  contents: read       # Checkout code
  packages: write      # Push zu ghcr.io

env:
  IMAGE: ghcr.io/${{ github.repository_owner }}/supply-chain-app:${{ github.sha }}

jobs:
  supply-chain:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------
      # Install tools
      # ------------------------------
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Trivy
        uses: aquasecurity/trivy-action@v0.2.5

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      # ------------------------------
      # Run security scans
      # ------------------------------
      - name: Security Scans
        run: |
          echo "Scanning source code..."
          trivy fs --severity HIGH,CRITICAL --exit-code 1 src/
          echo "Scanning dependencies..."
          trivy fs --severity HIGH,CRITICAL --exit-code 1 src/ --scan-all
          echo "Scanning Dockerfile..."
          trivy dockerfile --severity HIGH,CRITICAL --exit-code 1 src/docker/Dockerfile
          echo "Scanning IaC..."
          trivy config --severity HIGH,CRITICAL --exit-code 1 src/iac/
          echo "Scanning K8s manifests..."
          trivy config --severity HIGH,CRITICAL --exit-code 1 src/k8s/

      # ------------------------------
      # Build image and generate attestations
      # ------------------------------
      - name: Build container with BuildKit + SBOM/Provenance
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.IMAGE }}
          build-args: |
            BUILD_ENV=ci
          outputs: type=local,dest=out
          provenance: true
          sbom: true

      - name: Prepare attestations folder
        run: mkdir -p attestations

      - name: Extract SBOM & Provenance
        run: |
          jq '.predicate' out/sbom.spdx.json > attestations/sbom.json
          jq '.predicate' out/provenance.json > attestations/provenance.json

      # ------------------------------
      # Generate vulnerability attestations
      # ------------------------------
      - name: Generate Vulnerability Attestations
        run: |
          trivy fs --format cosign-vuln --output attestations/vuln-source.json src/
          trivy config --format cosign-vuln --output attestations/vuln-iac.json src/iac/
          trivy image --format cosign-vuln --output attestations/vuln-image.json ${{ env.IMAGE }}

      # ------------------------------
      # Keyless Signing (image + attestations)
      # ------------------------------
      - name: Sign Container Image
        run: |
          cosign sign --oidc-token ${{ secrets.GITHUB_TOKEN }} ${{ env.IMAGE }}

      - name: Sign Provenance Attestation
        run: |
          cosign attest --type slsaprovenance --predicate attestations/provenance.json ${{ env.IMAGE }}

      - name: Sign SBOM Attestation
        run: |
          cosign attest --type spdxjson --predicate attestations/sbom.json ${{ env.IMAGE }}

      - name: Sign Vulnerability Attestations
        run: |
          cosign attest --type vuln --predicate attestations/vuln-source.json ${{ env.IMAGE }}
          cosign attest --type vuln --predicate attestations/vuln-iac.json ${{ env.IMAGE }}
          cosign attest --type vuln --predicate attestations/vuln-image.json ${{ env.IMAGE }}

      # ------------------------------
      # Verification
      # ------------------------------
      - name: Verify Image Signature
        run: |
          cosign verify --certificate-identity-regexp=".*" --certificate-oidc-issuer-regexp=".*" ${{ env.IMAGE }}

      - name: Verify Attestations
        run: |
          cosign verify-attestation --type slsaprovenance ${{ env.IMAGE }}
          cosign verify-attestation --type spdxjson ${{ env.IMAGE }}
          cosign verify-attestation --type vuln ${{ env.IMAGE }}

      - name: Check Rekor Transparency Log
        run: |
          HASH=$(echo ${{ env.IMAGE }} | cut -d@ -f2 | cut -d: -f2)
          rekor-cli search --sha $HASH
