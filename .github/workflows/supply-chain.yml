name: Supply Chain CI

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/supply-chain-app

jobs:
  supply-chain:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------
      # Phase 1 – Security Scanning
      # ----------------------------
      - name: Run source & dependency scan
        run: |
          trivy fs --severity HIGH,CRITICAL --exit-code 1 src/

      - name: Run IaC scan
        run: |
          trivy config --severity HIGH,CRITICAL --exit-code 1 src/iac/

      - name: Run image scan
        run: |
          docker build -t temp-scan .
          trivy image --severity HIGH,CRITICAL --exit-code 1 temp-scan

      # ----------------------------
      # Phase 2 – Build with Attestations
      # ----------------------------
      - name: Build and push image with provenance and SBOM
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          provenance: true
          sbom: true

      - name: Export image digest
        run: |
          echo "DIGEST=${{ steps.build.outputs.digest }}" >> $GITHUB_ENV
          echo "IMAGE=${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}" >> $GITHUB_ENV

      # ----------------------------
      # Phase 3 – Signing
      # ----------------------------
      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign image
        run: cosign sign --yes $IMAGE

      - name: Attach SBOM attestation
        run: |
          cosign attest --yes \
            --type spdxjson \
            --predicate out/sbom.spdx.json \
            $IMAGE

      - name: Attach provenance attestation
        run: |
          cosign attest --yes \
            --type slsaprovenance \
            --predicate out/provenance.json \
            $IMAGE

      # ----------------------------
      # Phase 4 – Verification
      # ----------------------------
      - name: Verify image signature
        run: |
          cosign verify \
            --certificate-identity-regexp=".*" \
            --certificate-oidc-issuer-regexp=".*" \
            $IMAGE

      - name: Verify attestations
        run: |
          cosign verify-attestation \
            --type spdxjson \
            --certificate-identity-regexp=".*" \
            --certificate-oidc-issuer-regexp=".*" \
            $IMAGE

      - name: Verify Rekor transparency
        run: |
          rekor-cli search --sha $(echo $DIGEST | cut -d: -f2)
